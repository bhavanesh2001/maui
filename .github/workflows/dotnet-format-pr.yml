name: Format PR Code

on:
  pull_request

permissions:
  pull-requests: write
  contents: read

jobs:
  dotnet-format:
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          fetch-depth: 0

      - name: Setup .NET Core SDK
        uses: actions/setup-dotnet@v3.2.0
        with:
          dotnet-version: 8.x

      - name: Run dotnet format (dry-run)
        id: format_check
        run: |
          dotnet format .\Microsoft.Maui.sln --no-restore --verify-no-changes --diagnostics-
        continue-on-error: true

      - name: Show formatting diff (if any)
        run: git diff

      - name: Comment on PR if formatting issues found
        if: steps.format_check.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: [
                "⚠️ **Formatting issues detected** in your pull request.",
                "",
                "Please run the following locally and push the updated code:",
                "",
                "```sh",
                "dotnet format Microsoft.Maui.sln --no-restore --exclude Templates/src --exclude-diagnostics CA1822",
                "```",
                "",
                "Then commit and push to resolve this check."
              ].join('\n')
            })


      - name: Fail the job if formatting is incorrect
        if: steps.format_check.outcome == 'failure'
        run: exit 1
